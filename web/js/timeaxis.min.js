;(function($){$.timeaxis=function(expr,opt){var $tx={set:{debug:false,expr:null,id:null},cfg:{load:{y:10,fc:0xe3e3e3,c:0x37B6F9,w:5,a:1},prog:{y:50,w:10,c:0x61e0ff,a:1},alarm:{y:40,w:20,c:0xfe0000,a:0.8},scale:{p:30,y:60,w:1,h:30,c:0xe3e3e3,a:1},pointer:{y:54,w:1,r:10,c:0xfbaa35,f:0xffffff,a:1},clip:{y:60,w:25,f:0xffad00,a:0.5},style:{scale:{font:'8px Arial Courier New',fill:0xb6b6b6,align:'center',lineHeight:8,y:5},arrow:{font:'bold 20px simsun',fill:0xfeaa30},clip:{font:'32px Impact, Charcoal, sans-serif',fill:0x009966}},text:{mth0:'Jan',mth1:'Feb',mth2:'Mar',mth3:'Apr',mth4:'May',mth5:'Jun',mth6:'Jul',mth7:'Aug',mth8:'Sep',mth9:'Oct',mth10:'Nov',mth11:'Dec'}},prop:{id:0,x:0,y:0,w:0,h:0,v:0,init:false,rafid:0,type:7,grain:'1d',mode:'live',timezone:0,timezoneofs:0,offset:0,speed:0,now:0,next:0,range:{start:0,end:0},vrange:{start:0,end:0},arange:{start:0,end:0},crange:{start:0,end:0},},data:{record:[],alarm:[]},obj:{tg:null,cav:null,ctx:null,stg:null,load:null,loadstr:null,base:null,scale:null,scalstr:null,pointer:null,axis:{record:null,alarm:null},arrow:{left:null,right:null},clip:{left:null,right:null,range:null}},fn:{init:function(expr,opt){$.extend($tx.set,opt);if(!$tx.set.id){$tx.set.id='timeaxis_'+new Date().getTime()}$tx.set.expr=expr;$tx.prop.id=$tx.set.id;$tx.obj.tg=$(expr);$tx.prop.w=$tx.obj.tg.width();$tx.prop.h=$tx.obj.tg.height();$tx.prop.v=$tx.prop.w-$tx.cfg.scale.p*2;$tx.prop.s=($tx.prop.v*$tx.prop.type)/($tx.prop.type*86400000);var ropt={transparent:true};if(/firefox/.test(navigator.userAgent.toLowerCase())){ropt={backgroundColor:0xffffff}};$tx.obj.ctx=PIXI.autoDetectRenderer($tx.prop.w,$tx.prop.h,ropt);$tx.obj.cav=$($tx.obj.ctx.view).appendTo($tx.obj.tg.empty());$tx.obj.cav.attr({id:$tx.prop.id});$tx.obj.stg=new PIXI.Container();$tx.fn.load('Loading');$tx.prop.rafid=requestAnimationFrame($tx.animate);return $tx},add:function(l,fn){$tx.event[l]=fn},load:function(args){if(typeof(args)=='string'){$tx.draw.load(args)}else{$tx.fn.remove($tx.obj.load);if($tx.obj.loadstr){$tx.obj.loadstr.visible=false}$tx.obj.load=null}return $tx.fn},error:function(s){$tx.fn.load(false);var obj=$tx.obj.loadstr;if(obj){obj.text=s;obj.visible=true}$tx.draw.render();cancelAnimationFrame($tx.prop.rafid);return $tx.fn},getText:function(key){return $tx.cfg.text[key]},fmDate:function(str,stz){return Date.UTC(str.substr(0,4),parseInt(str.substr(5,2))-1,str.substr(8,2),str.substr(11,2),str.substr(14,2),str.substr(17,2),0)+(stz?0:$tx.prop.timezone)},check:function(d){var len=$tx.data.record.length;var res={result:false,datetime:$tx.prop.range.end};for(var i=0;i<len;++i){var r=$tx.data.record[i];if(d>=r.s&&d<r.e){res.result=true;res.start=r.s;res.datetime=d;res.end=r.e;break}else if(d<r.s){res.result=false;res.start=r.s;res.datetime=r.s;res.end=r.e;break}}return res},timeToX:function(dt){var prop=$tx.prop;var x=0;if('number'==typeof(dt)&&dt>=prop.vrange.start){x=prop.v*((dt-prop.vrange.start)/(prop.vrange.end-prop.vrange.start))}return x},xToTime:function(x){var prop=$tx.prop;var dt=0;if('number'==typeof(x)){var s=prop.vrange.start;var ofs=prop.vrange.end-s;var ndt=parseInt(s+ofs*x/prop.v);dt=ndt-ndt%1000}return dt},getRecTime:function(s,e){var prop=$tx.prop;if(!s&&!e){s=prop.crange.start;e=prop.crange.end}var time=0;var len=$tx.data.record.length;for(var i=0;i<len;++i){var r=$tx.data.record[i];if(r.e<s){continue}if(r.e>=e&&r.s<=s){time+=e-s}else if(r.e>s&&r.s<=s){time+=r.e-s}else if(r.e<e&&r.s>=s){time+=r.e-r.s}else if(r.e>=e&&r.s<e){time+=e-r.s}else if(r.s>=e){break}}if(time==0){time=e-s}return time/1000},offset:function(dt){var prop=$tx.prop;var os=prop.offset;var tc=0;switch(prop.grain){case'1h':tc=3600000;break;case'5m':tc=300000;break;default:tc=86400000}prop.offset=(-prop.v*(prop.vrange.start-prop.arange.start)/tc)+$tx.cfg.scale.p;prop.speed=Math.abs(os-prop.offset)/ (60 * (dt?dt:1000) /1000);if(prop.offset<os){prop.aniTurnSt=1}else{prop.aniTurnSt=-1}$tx.event.turn(prop.vrange.start)},remove:function(arg){if('object'==typeof(arg)){$tx.obj.stg.removeChild(arg)}else if('number'==typeof(arg)){$tx.obj.stg.removeChildAt(arg)}$tx.draw.render()},destroy:function(){cancelAnimationFrame($tx.prop.rafid);$tx.obj.stg.removeChildren();$tx.draw.render();for(k in $tx.obj){$tx.obj[k]=null}$tx.prop.init=false;return $tx}},draw:{load:function(str){var cfg=$tx.cfg.load;var t=$tx.obj.loadstr;if(!t){t=$tx.obj.loadstr=new PIXI.Text(str?str:'Loading',{fill:cfg.fc});t.x=$tx.prop.w/2;t.y=cfg.y;t.anchor=new PIXI.Point(0.5,0);$tx.obj.stg.addChild(t)}else{t.text=str?str:'Loading'}var g=$tx.obj.load;if(!g){g=$tx.obj.load=new PIXI.Graphics();g.lineStyle(cfg.w,cfg.c,cfg.a);g.moveTo(0,$tx.prop.h/2+20);g.lineTo(5,$tx.prop.h/2+20);$tx.obj.stg.addChild(g)}else{g.alpha=0.15}},prog:function(args){var cfg=$tx.cfg.prog;var g=$tx.obj.axis.record;var px=$tx.prop.s;var s=$tx.prop.arange.start;if(!g){g=$tx.obj.axis.record=new PIXI.Graphics();g.beginFill(cfg.c,0);g.moveTo(0,cfg.y);g.lineTo(1,cfg.y);g.lineTo(1,cfg.y+cfg.w);g.lineTo(0,cfg.y+cfg.w);g.beginFill(cfg.c,cfg.a);$.each($tx.data.record,function(i,o){g.moveTo((o.s-s)*px,cfg.y);g.lineTo((o.e-s)*px,cfg.y);g.lineTo((o.e-s)*px,cfg.y+cfg.w);g.lineTo((o.s-s)*px,cfg.y+cfg.w)});g.endFill();g.x=$tx.cfg.scale.p;$tx.prop.offset=g.x;$tx.obj.stg.addChild(g)}else{var w=g.width;var m=($tx.prop.now-s)*px;switch($tx.prop.grain){case'1h':w=w/24;break;case'5m':w=w/288;break}g.beginFill(0x99FF00,cfg.a);g.moveTo(w,cfg.y);g.lineTo(m,cfg.y);g.lineTo(m,cfg.y+cfg.w);g.lineTo(w,cfg.y+cfg.w);g.endFill()}},alarm:function(args){var cfg=$tx.cfg.alarm;var g=$tx.obj.axis.alarm;if(!g){g=$tx.obj.axis.alarm=new PIXI.Graphics()}else{g.clear()}g.beginFill(cfg.c,cfg.a);var px=$tx.prop.s;var s=$tx.prop.arange.start;$.each($tx.data.alarm,function(i,o){g.moveTo((o.s-s)*px,cfg.y);g.lineTo((o.e-s)*px,cfg.y);g.lineTo((o.e-s)*px,cfg.y+cfg.w);g.lineTo((o.s-s)*px,cfg.y+cfg.w)});g.endFill();g.x=$tx.cfg.scale.p;$tx.obj.stg.addChild(g)},scale:function(args){var prop=$tx.prop;var cfg=$tx.cfg.scale;var sty=$tx.cfg.style.scale;var g=$tx.obj.scale;var p=new PIXI.Point(0.5,0);if(!g){g=new PIXI.Graphics();g.lineStyle(cfg.w,cfg.c,cfg.a);g.moveTo(0,cfg.y);g.lineTo(prop.w,cfg.y);$tx.obj.base=g;$tx.obj.stg.addChild($tx.obj.base)}else{$tx.fn.remove(g)}g=$tx.obj.scale=new PIXI.Graphics();g.lineStyle(cfg.w,cfg.c,cfg.a);if('1d'==prop.grain){for(var i=0;i<25;++i){var x=(prop.w-cfg.p*2)/24*i+cfg.p;g.moveTo(x,cfg.y);g.lineTo(x,cfg.y-cfg.h);var date=new Date(prop.vrange.start+(i*3600000)+(new Date().getTimezoneOffset()*60000));if(i==0){t=new PIXI.Text(date.format('hhtt\n'+$tx.fn.getText('mth'+date.getMonth())+'dd'),sty)}else{t=new PIXI.Text(date.format('hh\ntt'),sty)}t.x=x;t.y=sty.y;t.anchor=p;g.addChild(t)}}else if('1h'==prop.grain){for(var i=0;i<61;++i){var x=(prop.w-cfg.p*2)/60*i+cfg.p;g.moveTo(x,cfg.y);if(i%5==0){g.lineTo(x,cfg.y-cfg.h)}else{g.lineTo(x,cfg.y-cfg.h+9)}if(i%5==0){var date=new Date(prop.vrange.start+(i*60000)+(new Date().getTimezoneOffset()*60000));var h=date.getHours();var m=date.getMinutes();if(0==i||(0==h&&0==m)){t=new PIXI.Text(date.format('hh:mmtt\n'+$tx.fn.getText('mth'+date.getMonth())+'dd'),sty)}else{t=new PIXI.Text(date.format('hh:mm\ntt'),sty)}t.x=x;t.y=sty.y;t.anchor=p;g.addChild(t)}}}else if('5m'==prop.grain){for(var i=0;i<31;++i){var x=(prop.w-cfg.p*2)/30*i+cfg.p;g.moveTo(x,cfg.y);if(i%6==0||i%3==0){g.lineTo(x,cfg.y-cfg.h)}else{g.lineTo(x,cfg.y-cfg.h+9)}if(i%6==0){var date=new Date(prop.vrange.start+(i*10000)+(new Date().getTimezoneOffset()*60000));var h=date.getHours();var m=date.getMinutes();if(0==i){t=new PIXI.Text(date.format('hh:mmtt\n'+$tx.fn.getText('mth'+date.getMonth())+'dd'),sty)}else{t=new PIXI.Text(date.format('hh:mm\ntt'),sty)}t.x=x;t.y=sty.y;t.anchor=p;g.addChild(t)}}}$tx.obj.stg.addChild(g)},arrow:function(args){var obj=$tx.obj.arrow;if(!obj.left&&!obj.right){obj.left=$tx.obj.arrow.left=new PIXI.Text('<',$tx.cfg.style.arrow);obj.right=$tx.obj.arrow.right=new PIXI.Text('>',$tx.cfg.style.arrow)}obj.left.x=5;obj.right.x=$tx.prop.w-15;obj.left.y=obj.right.y=$tx.prop.h/2-5;$tx.obj.stg.addChild(obj.left);$tx.obj.stg.addChild(obj.right)},pointer:function(args){var cfg=$tx.cfg.pointer;var obj=$tx.obj.pointer;if(!obj){obj=$tx.obj.pointer=new PIXI.Graphics()}obj.lineStyle(cfg.w,cfg.c,cfg.a);obj.beginFill(cfg.f,cfg.a);obj.drawCircle($tx.cfg.scale.p,cfg.y,cfg.r);obj.endFill();$tx.obj.stg.addChild(obj)},clip:function(st){var cfg=$tx.cfg.clip;var obj=$tx.obj.clip;var prop=$tx.prop;if(st){if(!obj.left&&!obj.right&&!obj.range){obj.left=$tx.obj.clip.left=new PIXI.Text('(',$tx.cfg.style.clip);obj.right=$tx.obj.clip.right=new PIXI.Text(')',$tx.cfg.style.clip);obj.range=$tx.obj.clip.range=new PIXI.Graphics()}obj.range.clear();obj.left.anchor=obj.right.anchor=new PIXI.Point(0.5,1);var xs=$tx.cfg.scale.p+$tx.fn.timeToX(prop.crange.start);var xe=$tx.cfg.scale.p+$tx.fn.timeToX(prop.crange.end);obj.range.beginFill(cfg.f,cfg.a);obj.range.moveTo(0,cfg.y);obj.range.lineTo(xe-xs,cfg.y);obj.range.lineTo(xe-xs,cfg.y-cfg.w);obj.range.lineTo(0,cfg.y-cfg.w);obj.range.endFill();obj.range.x=xs;obj.left.x=xs;obj.right.x=xe;obj.left.y=obj.right.y=$tx.cfg.scale.y+4;$tx.obj.stg.addChild(obj.range);$tx.obj.stg.addChild(obj.right);$tx.obj.stg.addChild(obj.left)}else{$tx.fn.remove(obj.left);$tx.fn.remove(obj.right);$tx.fn.remove(obj.range)}},render:function(){$tx.obj.ctx.render($tx.obj.stg)}},event:{bind:function(){var prop=$tx.prop;var arr=$tx.obj.arrow;arr.left.buttonMode=true;arr.left.interactive=true;arr.right.buttonMode=true;arr.right.interactive=true;arr.left.on('click',function(event){if(prop.vrange.start>prop.arange.start){switch(prop.grain){case'1h':prop.vrange.start-=1800000;prop.vrange.end-=1800000;break;case'5m':prop.vrange.start-=300000;prop.vrange.end-=300000;break;default:prop.vrange.start-=43200000;prop.vrange.end-=43200000}$tx.fn.offset(500)}});arr.right.on('click',function(event){if(prop.vrange.end<prop.arange.end){switch(prop.grain){case'1h':prop.vrange.start+=1800000;prop.vrange.end+=1800000;break;case'5m':prop.vrange.start+=300000;prop.vrange.end+=300000;break;default:prop.vrange.start+=43200000;prop.vrange.end+=43200000}$tx.fn.offset(500)}});var poi=$tx.obj.pointer;poi.buttonMode=true;poi.interactive=true;poi.on('mousedown',function(event){this.dragging=true;this.data=event.data;this.alpha=0.8}).on('mouseup',function(){this.dragging=false;this.data=null;this.alpha=1;var s=prop.vrange.start;var ofs=prop.vrange.end-s;var ndt=parseInt(s+ofs*this.x/prop.v);ndt=ndt-ndt%1000;var res=$tx.fn.check(ndt);if(!res.result){if(ndt>res.datetime){poi.moving=-1}else{poi.moving=1}}if(prop.now!=prop.range.start){if(res.datetime<prop.range.end){prop.next=res.end;prop.mode='vod'}else{prop.mode='live'}prop.now=res.datetime;$tx.event.play(prop.now-prop.timezone)}}).on('mousemove',function(){if(this.dragging){var x=this.data.getLocalPosition(this.parent).x-$tx.cfg.scale.p;if(x<0){x=0}else if(x>prop.v){x=prop.v}this.x=x}}).on('mouseover',function(){this.isOver=true}).on('mouseout',function(){this.isOver=false});var rec=$tx.obj.axis.record;rec.buttonMode=true;rec.interactive=true;rec.on('click',function(event){var x=event.data.getLocalPosition($tx.obj.stg).x;var p=$tx.cfg.scale.p;if(x>p&&x<prop.w-p){var s=prop.vrange.start;var ofs=prop.vrange.end-s;var ndt=parseInt(s+ofs*(x-p)/prop.v);prop.now=ndt-ndt%1000;$tx.obj.pointer.x=x-p;var res=$tx.fn.check(prop.now);prop.next=res.end;prop.mode='vod';$tx.event.play(prop.now-prop.timezone)}})},play:function(d){console.log('PLAY:\t'+d)},offset:function(ofs){console.log('VOD Offset:\t'+ofs)},turn:function(d){},clippick:function(s,e){console.log('CLIP Pick:\ts:'+s+'\te:'+e)}},animate:function(){var prop=$tx.prop;var load=$tx.obj.load;var poi=$tx.obj.pointer;var sca=$tx.obj.scale;var rec=$tx.obj.axis.record;var ala=$tx.obj.axis.alarm;var arrl=$tx.obj.arrow.left;var arrr=$tx.obj.arrow.right;if(load){load.as=load.as?load.as+0.3:1;if(load.x<prop.w){load.x+=load.as;load.width+=30}else{load.x=0;load.width=5;load.as=1}}if(poi&&poi.isOver&&3>poi.lineWidth){var cfg=$tx.cfg.pointer;var lastLW=poi.lineWidth;var lastA=poi.alpha;poi.clear();poi.lineStyle(3>lastLW?lastLW+0.1:3,cfg.c,cfg.a);poi.beginFill(cfg.f,cfg.a);poi.drawCircle($tx.cfg.scale.p,cfg.y,cfg.r);poi.endFill()}else if(poi&&!poi.dragging&&!poi.isOver&&1<poi.lineWidth){var cfg=$tx.cfg.pointer;var lastLW=poi.lineWidth;var lastA=poi.alpha;poi.clear();poi.lineStyle(1<lastLW?lastLW-0.1:1,cfg.c,cfg.a);poi.beginFill(cfg.f,cfg.a);poi.drawCircle($tx.cfg.scale.p,cfg.y,cfg.r);poi.endFill()}if(poi&&poi.moving){if(!poi.mx){poi.mx=prop.v*(prop.now-prop.vrange.start)/(prop.vrange.end-prop.vrange.start);poi.ms=(poi.mx-poi.x)/30}if(0>poi.moving&&poi.x>poi.mx||0<poi.moving&&poi.x<poi.mx){poi.x+=poi.ms}else{poi.x=poi.mx;poi.moving=false;delete(poi.mx);delete(poi.ms)}}if(prop.aniTurnSt){var s=prop.speed;sca.alpha-=0.1;poi.visible=false;if(0>prop.aniTurnSt&&prop.offset>rec.x){if(rec.x+s<prop.offset){rec.x+=s;ala.x+=s}else{rec.x=ala.x=prop.offset}}else if(0<prop.aniTurnSt&&prop.offset<rec.x){rec.x-=s;ala.x-=s}else{if(!prop.aniZoomSt){$tx.draw.scale();$tx.obj.stg.swapChildren(poi,$tx.obj.scale)}rec.x=ala.x=prop.offset;prop.aniTurnSt=0}}if(arrl&&((prop.vrange.start<=prop.arange.start)||'clip'==prop.mode)&&arrl.alpha>0){arrl.alpha-=0.05;arrl.buttonMode=false;arrl.interactive=false}else if(arrl&&prop.vrange.start>prop.arange.start&&arrl.alpha<1){arrl.alpha+=0.05;arrl.buttonMode=true;arrl.interactive=true}if(arrr&&((prop.vrange.end>=prop.arange.end)||'clip'==prop.mode)&&arrr.alpha>0){arrr.alpha-=0.05;arrr.buttonMode=false;arrr.interactive=false}else if(arrr&&prop.vrange.end<prop.arange.end&&arrr.alpha<1){arrr.alpha+=0.05;arrr.buttonMode=true;arrr.interactive=true}if(prop.aniZoomSt){var sxp=prop.sxp;var xs=rec.scale.x;var s=prop.aniZoom;sca.alpha-=0.03;poi.visible=false;if(!sxp){sxp=prop.sxp=Math.abs(s-xs)/60}if(0>prop.aniZoomSt&&xs>s){if(rec.scale.x-sxp>1){rec.scale.x-=sxp;ala.scale.x-=sxp}else{rec.scale.x=ala.scale.x=1}}else if(0<prop.aniZoomSt&&xs<s){if(rec.scale.x+sxp<s){rec.scale.x+=sxp;ala.scale.x+=sxp}else{rec.scale.x=ala.scale.x=s}}else{prop.sxp=0;$tx.draw.scale();$tx.obj.stg.swapChildren(poi,$tx.obj.scale);rec.scale.x=ala.scale.x=s;prop.aniZoomSt=0}}$tx.draw.render();$tx.prop.rafid=requestAnimationFrame($tx.animate)},api:{ready:function(){$tx.prop.init=true;$tx.fn.load(false);$tx.obj.stg.removeChildren();$tx.draw.prog();$tx.draw.alarm();$tx.draw.scale();$tx.draw.arrow();$tx.draw.pointer();$tx.event.bind();$tx.api.go()},setTimezone:function(ms){$tx.prop.timezone=ms},setTimezoneOffset:function(ms){$tx.prop.timezoneofs=ms},setType:function(type){$tx.prop.type=type},setRecord:function(data){var prop=$tx.prop;$tx.data.record=[];$tx.data.alarm=[];var ctime=$tx.fn.fmDate(data['current_time'],true);var ztime=ctime+prop.timezoneofs;var ctstr=new Date(ctime).format('yyyy-MM-dd');var ztstr=new Date(ztime).format('yyyy-MM-dd');var stime=$tx.fn.fmDate(ctstr,true);if(ctstr!=ztstr){stime=$tx.fn.fmDate(ztstr,true)}prop.vrange.start=stime;prop.vrange.end=prop.vrange.start+86400000;prop.arange.start=prop.vrange.end-prop.type*86400000;prop.arange.end=prop.vrange.end;$.each(data.data,function(i,o){var st={s:$tx.fn.fmDate(o['start_time']),e:$tx.fn.fmDate(o['end_time'])};if(st.s<=prop.arange.start&&st.e>prop.arange.start){st.s=prop.arange.start}if(st.s>=prop.arange.start){if('1'==o['record_type']){$tx.data.alarm.push(st)}else{$tx.data.record.push(st)}}});$tx.prop.now=ctime;if(!$tx.data.record.length){$tx.data.record.push({s:$tx.prop.now,e:$tx.prop.now})}prop.range.start=$tx.data.record[0].s;prop.range.end=$tx.data.record[$tx.data.record.length-1].e},setGrain:function(g){var prop=$tx.prop;if(prop.grain===g||'clip'==prop.mode){return false}switch(g){case'1h':if(prop.now>=prop.vrange.start&&prop.now<prop.vrange.end){var date=new Date(prop.now);date.setMinutes(0);date.setSeconds(0);date.setMilliseconds(0);prop.vrange.start=date.getTime()}prop.vrange.end=prop.vrange.start+3600000;prop.aniZoom=24;break;case'5m':if(prop.now>=prop.vrange.start&&prop.now<prop.vrange.end){var date=new Date(prop.now);date.setMinutes(date.getMinutes()-date.getMinutes()%5);date.setSeconds(0);date.setMilliseconds(0);prop.vrange.start=date.getTime()}prop.vrange.end=prop.vrange.start+300000;prop.aniZoom=288;break;default:if(prop.now>=prop.vrange.start&&prop.now<prop.vrange.end){var date=new Date(prop.now);date.setUTCHours(0);date.setMinutes(0);date.setSeconds(0);date.setMilliseconds(0);prop.vrange.start=date.getTime()}prop.vrange.end=prop.vrange.start+86400000;prop.aniZoom=1}prop.grain=g;prop.aniZoomSt=($tx.obj.axis.record.scale.x>prop.aniZoom?-1:1);$tx.fn.offset();return true},go:function(d){var prop=$tx.prop;if('clip'==prop.mode){return false}if('string'==typeof(d)){d=$tx.fn.fmDate(d,true)}if('number'!=typeof(d)||d<prop.arange.start){d=$tx.data.record[$tx.data.record.length-1].e}var date=new Date(d);switch(prop.grain){case'1h':date.setMinutes(0);date.setSeconds(0);date.setMilliseconds(0);prop.vrange.start=date.getTime();prop.vrange.end=prop.vrange.start+3600000;break;case'5m':date.setMinutes(date.getMinutes()-date.getMinutes()%5);date.setSeconds(0);date.setMilliseconds(0);prop.vrange.start=date.getTime();prop.vrange.end=prop.vrange.start+300000;break;default:date.setUTCHours(0);date.setMinutes(0);date.setSeconds(0);date.setMilliseconds(0);prop.vrange.start=date.getTime();prop.vrange.end=prop.vrange.start+86400000}$tx.fn.offset();return true},live:function(){var prop=$tx.prop;if('clip'==prop.mode||'vod'!=prop.mode){return false}prop.mode='live';prop.now=prop.range.end;$tx.api.go();$tx.event.play(prop.now-prop.timezone);return true},vod:function(d){var prop=$tx.prop;if('string'==typeof(d)){d=$tx.fn.fmDate(d,true)}var res=$tx.fn.check(d);if(res.result){prop.now=res.datetime;prop.next=res.end;prop.mode='vod';$tx.event.play(prop.now-prop.timezone);setTimeout(function(){$tx.api.go(prop.now)},1500);return true}return false},clip:function(act){var prop=$tx.prop;var clip=$tx.obj.clip;var poi=$tx.obj.pointer;var rec=$tx.obj.axis.record;if(act){poi.visible=false;rec.buttonMode=false;rec.interactive=false;var now=prop.now-prop.now%1000;prop.crange.end=prop.range.end;if(now>=prop.vrange.start&&now<prop.vrange.end){if('live'!=prop.mode&&now+150000<prop.range.end){prop.crange.end=now+150000}}else{prop.crange.end=prop.vrange.start+(prop.vrange.end-prop.vrange.start)/2+150000}prop.crange.start=prop.crange.end-300000;if(prop.crange.start<prop.vrange.start){prop.crange.start=prop.vrange.start}$tx.draw.clip(true);var rangeReDraw=function(xs,xe){var cfg=$tx.cfg.clip;clip.range.clear();clip.range.beginFill(cfg.f,cfg.a);clip.range.moveTo(0,cfg.y);clip.range.lineTo(xe-xs,cfg.y);clip.range.lineTo(xe-xs,cfg.y-cfg.w);clip.range.lineTo(0,cfg.y-cfg.w);clip.range.endFill();clip.range.x=xs};$.each(clip,function(k,obj){obj.alpha=0.8;obj.buttonMode=true;obj.interactive=true;obj.on('mousedown',function(event){this.dragging=true;this.data=event.data;if('left'==k){clip.right.dragging=false;clip.range.dragging=false}else if('right'==k){clip.left.dragging=false;clip.range.dragging=false}else if('range'==k){clip.left.dragging=false;clip.right.dragging=false;this.ofs=this.data.getLocalPosition(this).x;this.ofw=$tx.fn.timeToX(prop.crange.end)-$tx.fn.timeToX(prop.crange.start)}}).on('mouseup',function(){this.dragging=false;this.data=null}).on('mousemove',function(){if(this.dragging){var p=$tx.cfg.scale.p;var xs=xe=0;if('left'==k){xs=this.data.getLocalPosition(this.parent).x-p;xe=$tx.fn.timeToX(prop.crange.end);var mn=$tx.fn.timeToX(prop.crange.end-1800000);var mx=$tx.fn.timeToX(prop.crange.end-30000);if(xs<mn){xs=mn}else if(xs<0){xs=0}else if(xs>mx){xs=mx}xs+=p;xe+=p;this.x=xs}else if('right'==k){xs=$tx.fn.timeToX(prop.crange.start);xe=this.data.getLocalPosition(this.parent).x-p;var mn=$tx.fn.timeToX(prop.crange.start+30000);var mx=$tx.fn.timeToX(prop.crange.start+1800000);var mx2=$tx.fn.timeToX(prop.now>prop.vrange.end?prop.vrange.end:prop.now);if(xe<mn){xe=mn}else if(xe>Math.min(mx,mx2)){xe=Math.min(mx,mx2)}xs+=p;xe+=p;this.x=xe}else if('range'==k){xs=this.data.getLocalPosition(this.parent).x-this.ofs-p;var mn=$tx.fn.timeToX(prop.range.start);var mx=$tx.fn.timeToX(prop.range.end);var ofw=this.ofw;if(xs<0){xs=0}else if(xs<mn){xs=mn}xe=xs+ofw;if(xe>mx&&mx-ofw>=0){xs=mx-ofw}else if(xe>prop.v){xs=prop.v-ofw}xs+=p;xe=xs+ofw;this.x=xs;clip.left.x=xs;clip.right.x=xe}if('left'==k){prop.crange.start=$tx.fn.xToTime(xs-p)}else if('right'==k){prop.crange.end=$tx.fn.xToTime(xe-p)}else if('range'==k){prop.crange.start=$tx.fn.xToTime(xs-p);prop.crange.end=$tx.fn.xToTime(xe-p)}if('function'==typeof($tx.event.clippick)){$tx.event.clippick(prop.crange.start,prop.crange.end)}if('range'!=k){rangeReDraw(xs,xe)}}}).on('mouseover',function(){this.alpha=1}).on('mouseout',function(){this.alpha=0.8})});prop.rmode=prop.mode;prop.mode='clip';if('function'==typeof($tx.event.clippick)){$tx.event.clippick(prop.crange.start,prop.crange.end)}}else{poi.visible=true;rec.buttonMode=true;rec.interactive=true;$tx.draw.clip(false);prop.mode=prop.rmode}},step:function(d){var prop=$tx.prop;var poi=$tx.obj.pointer;d=d-d%1000+prop.timezone;if(prop.init&&'clip'!=prop.mode&&poi&&!poi.dragging&&!poi.moving){if('vod'==prop.mode&&d>prop.next){var res=$tx.fn.check(d);$tx.event.offset(res.start-prop.next);prop.next=res.end;if(res.start>prop.vrange.end){$tx.obj.arrow.right.emit('click')}}prop.now=d;var x=0;if(prop.now<prop.vrange.end){if(prop.now>=prop.range.end){prop.range.end=prop.now;$tx.data.record[$tx.data.record.length-1].e=prop.now;if(!prop.aniZoomSt){$tx.draw.prog()}}x=$tx.fn.timeToX(prop.now)}else if(prop.now>prop.vrange.start&&prop.now<=prop.vrange.end){if(prop.now>=prop.arange.end){location.reload()}else if(prop.now>=prop.vrange.end){$tx.obj.arrow.right.emit('click')}}poi.x=x;if(prop.now>=prop.vrange.start&&prop.now<prop.vrange.end){poi.visible=true}}}}};return $tx.fn.init(expr,opt)}})(jQuery);